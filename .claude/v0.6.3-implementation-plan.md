# v0.6.3 Implementation Plan

**Theme:** Trunk-Based CI/CD + Release Automation + Workflow Enforcement

**Last Updated:** 2025-10-25

## Overview

This release implements trunk-based development with strong CI/CD, automated release hygiene checks, and workflow enforcement hooks.

## Issues in Milestone (7 total)

1. **#29** - Version sync automation
2. **#44** - Issue tracking workflow enforcement (hooks)
3. **#45** - Milestone planning enforcement (hooks)
4. **#46** - Release workflow automation (CI + RC tags)
5. **#47** - Fix test_hooks.sh hanging (bug fix)
6. **#49** - Directory cleanup (.claude, scripts, docs)
7. **#56** - Document trunk-based workflow

## Implementation Components

### 1. Release Workflow Automation (#46)

**Core component:** Automated hygiene checks triggered by RC tags

**Files to create:**
- `.github/workflows/release-hygiene.yml` - Comprehensive checks on RC tags
- `.github/workflows/release.yml` - Auto-create releases on final tags
- `scripts/release/check_hygiene.sh` - Orchestrates all hygiene checks
- `scripts/release/check_milestone.sh` - Verify milestone status
- `scripts/release/run_subagent_reviews.sh` - Launch parallel subagent reviews

**Hygiene checks:**
- ✅ All tests pass (unit, integration, e2e)
- ✅ Version sync verified (existing script)
- ✅ Test coverage gaps review (subagent)
- ✅ Documentation complete (subagent) - includes migration guides, ROADMAP.md
- ✅ Code quality review (subagent)
- ✅ Directory organization review (subagent)
- ✅ AppleScript safety audit (subagent)
- ✅ Milestone verification (all issues closed, next milestone exists)

**RC tag workflow:**
```bash
# Tag RC
git tag v0.6.3-rc1
git push --tags

# GitHub Actions triggered:
# 1. Run all hygiene checks
# 2. Post results as PR comment or issue comment
# 3. Pass/fail status

# If fail: fix and tag rc2
# If pass: tag final release
git tag v0.6.3
git push --tags
# Auto-creates GitHub release and closes milestone
```

### 2. Version Sync Automation (#29)

**Goal:** Eliminate manual version updates across files

**Approach:**
- Hook detects version bump in pyproject.toml
- Automatically updates .claude/CLAUDE.md, CHANGELOG.md, README.md
- Verification script ensures sync (already exists: `scripts/check_version_sync.sh`)

**Files to create/modify:**
- `scripts/release/sync_version.sh` - Auto-update all version files
- Enhance `.git/hooks/pre-commit` to call sync script

### 3. Milestone Planning Enforcement (#45)

**Goal:** Keep work focused on current milestone

**Hooks to implement:**

**SessionStart hook enhancement:**
```bash
# Load current version + milestone
CURRENT_VERSION=$(grep '^version = ' pyproject.toml | cut -d'"' -f2)
MILESTONE="v${CURRENT_VERSION%.*}.$((${CURRENT_VERSION##*.} + 1))"  # Next patch

# Show milestone status
echo "📍 Current Version: v$CURRENT_VERSION"
echo "🎯 Active Milestone: $MILESTONE"
echo ""
gh issue list --milestone "$MILESTONE" --json number,title,assignee
echo ""

# Check next milestone exists
NEXT_MINOR="v0.$((${CURRENT_VERSION#*.*.} + 1)).0"
if ! gh api "repos/:owner/:repo/milestones" | jq -e ".[] | select(.title == \"$NEXT_MINOR\")" > /dev/null; then
    echo "⚠️  WARNING: No next milestone ($NEXT_MINOR) exists"
    echo "   Consider creating it to plan future work"
fi
```

**PreToolUse(Task) hook (new):**
```bash
# Before launching any Task subagent
# Verify current milestone exists and has issues

MILESTONE=$(get_current_milestone)
if [ -z "$MILESTONE" ]; then
    echo "❌ No active milestone found"
    echo "   Create milestone first: gh milestone create v0.X.Y"
    exit 2
fi

ISSUE_COUNT=$(gh issue list --milestone "$MILESTONE" --json number | jq length)
if [ "$ISSUE_COUNT" -eq 0 ]; then
    echo "⚠️  Active milestone $MILESTONE has no issues"
    echo "   Add issues to milestone or create them first"
fi
```

**Files to modify:**
- `scripts/hooks/session_start.sh` - Add milestone display
- `scripts/hooks/pre_task.sh` (NEW) - Verify milestone before Task agents

### 4. Issue Tracking Workflow Enforcement (#44)

**Goal:** Ensure all work references issues and follows TDD

**Git hook enhancements:**

**`.git/hooks/pre-commit` additions:**
```bash
# Check commit message references issue
COMMIT_MSG=$(cat .git/COMMIT_EDITMSG 2>/dev/null || echo "")
if ! echo "$COMMIT_MSG" | grep -qE "#[0-9]+|MISTAKE-[0-9]+"; then
    WARNINGS+=("⚠️  MISSING-ISSUE: Commit message doesn't reference an issue")
    WARNINGS+=("   Format: 'fix: description (#47)' or 'feat: description (#44)'")
fi

# Check if issue is in current milestone
ISSUE_NUM=$(echo "$COMMIT_MSG" | grep -oE "#[0-9]+" | head -1 | tr -d '#')
if [ -n "$ISSUE_NUM" ]; then
    MILESTONE=$(get_current_milestone)
    if ! gh issue view "$ISSUE_NUM" --json milestone | jq -e ".milestone.title == \"$MILESTONE\"" > /dev/null 2>&1; then
        WARNINGS+=("ℹ️  INFO: Issue #$ISSUE_NUM is not in current milestone ($MILESTONE)")
        WARNINGS+=("   This is OK for bug fixes or future work, but verify intentional")
    fi
fi
```

**Claude Code hook enhancement:**

**`scripts/hooks/pre_bash.sh` additions:**
```bash
# Check if working on assigned issue
check_issue_assignment() {
    # Get issue from branch name (e.g., feature/issue-44-enforce-tracking)
    BRANCH=$(git rev-parse --abbrev-ref HEAD)
    ISSUE_NUM=$(echo "$BRANCH" | grep -oE "[0-9]+" | head -1)

    if [ -n "$ISSUE_NUM" ]; then
        ASSIGNEE=$(gh issue view "$ISSUE_NUM" --json assignees --jq '.assignees[].login')
        CURRENT_USER=$(gh api user --jq '.login')

        if [ "$ASSIGNEE" != "$CURRENT_USER" ] && [ -n "$ASSIGNEE" ]; then
            echo "⚠️  Issue #$ISSUE_NUM is assigned to $ASSIGNEE, not you"
            echo "   Consider coordinating to avoid conflicts"
        fi
    fi
}
```

### 5. Fix test_hooks.sh Hanging (#47)

**Problem:** Test 2 hangs due to command substitution + nested quotes

**Investigation needed:**
- Simplify test approach
- Possibly rewrite tests in Python instead of Bash
- Or use different test harness

**Files to modify:**
- `tests/test_hooks.sh`

### 6. Directory Cleanup (#49)

**Goal:** Organize .claude/, scripts/, docs/ directories

**Subagent review as part of release hygiene:**
- Audit all three directories
- Identify outdated/obsolete files
- Propose reorganization
- Update documentation references

**Proposed structure:**
```
scripts/
├── release/          # Release automation (NEW)
│   ├── check_hygiene.sh
│   ├── sync_version.sh
│   └── check_milestone.sh
├── hooks/            # Claude Code hooks (RENAME from current)
│   ├── pre_bash.sh
│   ├── post_bash.sh
│   ├── session_start.sh
│   └── pre_task.sh (NEW)
├── git-hooks/        # Git hooks (KEEP)
│   └── pre-commit
└── utils/            # Utility scripts (REORGANIZE)
    ├── check_complexity.sh
    ├── check_version_sync.sh
    └── log_mistake.sh

.claude/
├── CLAUDE.md         # Main project memory
├── settings.json     # Hook configuration
├── mistakes/         # Mistake tracking
└── archive/          # Old files (NEW - move obsolete content)
    └── CLAUDE-redesign-phase.md

docs/
├── guides/           # User-facing guides
├── reference/        # Technical reference
└── project/          # Project management
```

### 7. Document Trunk-Based Workflow (#56)

**Files to update:**
- `README.md` - Installation instructions with tags
- `docs/guides/CONTRIBUTING.md` - Contributor workflow
- `docs/project/ROADMAP.md` - Document strategy decision
- `.claude/CLAUDE.md` - Update workflow references

## Implementation Order

**Phase 1: Foundation (Issues #47, #49, #56)**
1. Fix test_hooks.sh (#47) - Unblock testing
2. Directory cleanup (#49) - Clean workspace
3. Document workflow (#56) - Clarity for implementation

**Phase 2: Automation Core (Issue #46)**
4. Release hygiene checks (#46)
   - Create GitHub Actions workflows
   - Create release scripts
   - Implement subagent reviews

**Phase 3: Version Sync (Issue #29)**
5. Version sync automation (#29)
   - Auto-update script
   - Hook integration

**Phase 4: Workflow Enforcement (Issues #44, #45)**
6. Milestone enforcement (#45)
7. Issue tracking enforcement (#44)

## Testing Strategy

**For each component:**
- Unit tests where applicable
- Integration tests with real GitHub API
- Manual testing of hooks
- End-to-end release dry run before v0.6.3

## Success Criteria

v0.6.3 release should:
- ✅ Use RC tag workflow (tag v0.6.3-rc1, checks run, tag v0.6.3)
- ✅ All hygiene checks automated
- ✅ Hooks enforce milestone/issue tracking
- ✅ Documentation reflects trunk-based workflow
- ✅ Directory structure organized
- ✅ Version sync automated

## Next Steps

1. Create feature branch: `feature/v0.6.3-trunk-based-cicd`
2. Start with Phase 1 (foundation work)
3. Iterate through phases
4. Test with RC tags before final release
